---
title: "Forecasting Flood Inundation"
author: "Johnathan Clementi & Itay Porat"
date: "3/30/2022"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	error = FALSE,
	message = FALSE,
	warning = FALSE,
	cache = FALSE,
	tidy = TRUE
)
```
# Introduction & Motivation
On average, flooding results in approximately 120 fatalities and about $5 billion in property damages across the United States on an annual basis [1][2]. It is advantageous, then, to be able to predict future flooding such that it may be mitigated. This is especially common in cities, which contain large areas of impermeable surfaces and concentrate human growth. Mitigation measures include:
1. Replace impermeable surfaces
1. Install water attenuation and infiltration devices
1. Improve storm water and waste water management systems
1. **Improve warning mechanisms**
We will focus on the last of these items: **improving warning mechanisms**. To do this, we have built a machine learning model which uses terrain, distance to existing water, and to predict prior flooding in Calgary, CA. We evaluated the effectiveness of the model by testing it on data held out from the model building process. Finally, we used the model to predict flooding in Pittsburgh, PA, USA.


```{r libraries, message=FALSE, warning=FALSE}
library(caret)
library(ckanr)
library(pscl)
library(plotROC)
library(pROC)
library(sf)
library(spdep)
library(tidyverse)
library(knitr)
library(kableExtra)
library(grid)
library(gridExtra)
library(tigris)
library(viridis)
library(raster)
```

```{r mapTheme, echo=TRUE}

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

mapTheme <- function() { 
            theme(plot.title =element_text(size=12),
                  plot.subtitle = element_text(size=8),
                  plot.caption = element_text(size = 6),
                  # axis.line=element_blank(),
                  # axis.text.x=element_blank(),
                  # axis.text.y=element_blank(),
                  # axis.ticks=element_blank(),
                  # axis.title.x=element_blank(),
                  # axis.title.y=element_blank(),
                  panel.background=element_blank(),
                  panel.border=element_blank(),
                  panel.grid.major=element_line(colour = 'transparent'),
                  panel.grid.minor=element_blank(),
                  legend.direction = "vertical", 
                  legend.position = "right",
                  plot.margin = margin(1, 1, 1, 1, 'cm'),
                  legend.key.height = unit(1, "cm"), legend.key.width = unit(0.2, "cm"))
            }

plotTheme <- function() { 
              theme(plot.title =element_text(size=12),
                    plot.subtitle = element_text(size=8),
                    plot.caption = element_text(size = 6),
                    axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
                    axis.text.y = element_text(size = 10),
                    axis.title.y = element_text(size = 10),
                    # Set the entire chart region to blank
                    panel.background=element_blank(),
                    plot.background=element_blank(),
                    #panel.border=element_rect(colour="#F0F0F0"),
                    # Format the grid
                    panel.grid.major=element_line(colour="#D0D0D0",size=.75),
                    axis.ticks=element_blank())
}

options(scipen =  "sf")
options(scipen = 999)
```

## Model Components: Data

### Calgary Data
```{r message=FALSE, warning=FALSE}
calgaryBoundary <- st_read('https://data.calgary.ca/resource/erra-cqp9.geojson') %>%
  st_transform(crs = 3776)
```

```{r createFishnet, eval=FALSE, include=FALSE}
### Create Fishnet
# cal_fishnet <- st_make_grid(calgaryBoundary, cellsize = 500, square = TRUE) %>%
#   .[calgaryBoundary] %>% # Clips to original boundary
#   st_sf() %>%
#   mutate(uniqueID = rownames(.))


# pgh_fishnet <- st_make_grid(pghBoundary, cellsize = 500, square = TRUE) %>%
#   .[pghBoundary] %>% # Clips to original boundary 
#   st_sf() %>%
#   mutate(uniqueID = rownames(.))

# st_write(cal_fishnet, 'D:/Users/Johnathan/Google Drive/Grad School/Penn_MUSA/Spring2022/675_LUaEModeling/Homework/3_ForecastingFloodInundation/CalgaryData/fishnet/cal_fishnet.shp')

# st_write(pgh_fishnet, 'D:/Users/Johnathan/Google Drive/Grad School/Penn_MUSA/Spring2022/675_LUaEModeling/Homework/3_ForecastingFloodInundation/PittsburghData/producedData/pgh_fishnet.shp')

cal_fishnet <- st_read('D:/Users/Johnathan/Google Drive/Grad School/Penn_MUSA/Spring2022/675_LUaEModeling/Homework/3_ForecastingFloodInundation/CalgaryData/fishnet/cal_fishnet.shp')

pgh_fishnet <- st_read('D:/Users/Johnathan/Google Drive/Grad School/Penn_MUSA/Spring2022/675_LUaEModeling/Homework/3_ForecastingFloodInundation/PittsburghData/producedData/pgh_fishnet.shp')
```

```{r eval=FALSE, fig.height=12, fig.width=24, include=FALSE}
calFish <- ggplot() +
  geom_sf(data = cal_fishnet) +
  geom_sf(data = calgaryBoundary, 
          color = "red", fill = "transparent") +
  mapTheme()

pghFish <- ggplot() +
  geom_sf(data = pgh_fishnet) +
  geom_sf(data = pghBoundary, 
          color = "red", fill = "transparent") +
  mapTheme()

grid.arrange(calFish, pghFish, nrow = 1)
```

```{r message=FALSE, warning=FALSE}
cal_PredictionFishnet <- st_read('D:/Users/Johnathan/Google Drive/Grad School/Penn_MUSA/Spring2022/675_LUaEModeling/Homework/3_ForecastingFloodInundation/CalgaryData/cal_toPredict.shp')

# Clean up colnames:
cal_PredictionFishnet <- cal_PredictionFishnet %>%
  rename(uniqueID = cal_fishne,
         CellAvgDistStream = calFish_17,
         CellAvgDistSteepSlope = calFish_11,
         CellAvgDistWetland = calFish__5,
         CellSumImpSurf = calFish_22,
         inundation = calFish_27) %>%
  dplyr::select(uniqueID, inundation, CellAvgDistStream, CellAvgDistSteepSlope, CellAvgDistWetland, CellSumImpSurf)

# Make uniqueID numeric
cal_PredictionFishnet$uniqueID <- as.numeric(cal_PredictionFishnet$uniqueID)
```

#### Dependent Variable Visualization
```{r fig.width=8, fig.height=8}
cal_PredictionFishnet %>%
  mutate(inundation = as.factor(inundation)) %>%
  ggplot() +
    geom_sf(aes(fill = inundation)) +
    scale_fill_manual(values = c("dark green", "dark blue"),
                        labels = c("No Inundation","Inundation")) +
    labs(title = "Historic Flood Inundation in Calgary, Alberta, CA") +
    mapTheme()
```


#### Indpendent Variable Visualizations
```{r fig.width=12, fig.height=12}
grid.arrange(    
    # Average Distance to stream or river features as created from a DEM
    cal_PredictionFishnet %>%
      ggplot() +
        geom_sf(aes(fill = CellAvgDistStream)) +
        scale_fill_viridis(direction = -1) +
        labs(title = "Average Distance to Streams or Rivers") +
        mapTheme()
    ,
    # Average Distance to steep slopes as created from a DEM
    # A steep slope is defined as a rise of 20% or more
    cal_PredictionFishnet %>%
      ggplot() +
        geom_sf(aes(fill = CellAvgDistSteepSlope)) +
        scale_fill_viridis(direction = -1) +
        labs(title = "Average Distance to Steep Slopes (>20% rise)") +
        mapTheme()
    ,
    # Average Distance to wetlands as retrieved from open data sources:
    # Alberta / Calgary: https://geospatial.alberta.ca/titan/rest/services/environment/alberta_merged_wetland_inventory/MapServer/3
    # Allegheny County / Pittsburgh: https://www.pasda.psu.edu/download/alleghenycounty/AlleghenyCounty_NWI2000.zip
    cal_PredictionFishnet %>%
      ggplot() +
        geom_sf(aes(fill = CellAvgDistWetland)) +
        scale_fill_viridis(direction = -1) +
        labs(title = "Average Distance to Wetlands") +
        mapTheme()
    ,
    # Summary of Impervious Surfaces
    # If a cell touches an impervious surface, it will be classified as having impervious surfaces
    # Land cover data: http://www.cec.org/north-american-environmental-atlas/land-cover-30m-2015-landsat-and-rapideye/
    cal_PredictionFishnet %>%
      ggplot() +
        geom_sf(aes(fill = CellSumImpSurf)) +
        scale_fill_viridis(direction = -1) +
        labs(title = "Summary of Impervious Surfaces") +
        mapTheme()
  , nrow=2, ncol=2
  )
```

## Model Components: Build Model

```{r}
set.seed(4326)
trainIdx <- createDataPartition(cal_PredictionFishnet$CellAvgDistSteepSlope, p=.7,
                                list=FALSE,
                                times=1)
Train <- cal_PredictionFishnet[trainIdx,]
test <- cal_PredictionFishnet[-trainIdx,]
```

```{r}
floodModel <- glm(inundation ~ ., 
                  family="binomial"(link="logit"),
                  data = Train %>% dplyr::select(-uniqueID) %>%
                    st_drop_geometry())

summary(floodModel)
```

```{r}
cal_Train_inundationProbs <- predict(floodModel, Train, type="response")

# hist(cal_Train_inundationProbs)
```

```{r plot_preds}
trainProbs <- data.frame(obs = as.numeric(Train$inundation),
                        pred = cal_Train_inundationProbs)

ggplot(trainProbs, aes(x = pred, fill=as.factor(obs))) + 
  geom_density() +
  facet_grid(obs ~ .) + 
  xlab("Probability") + 
  geom_vline(xintercept = .32) +
  scale_fill_manual(values = c("dark green", "dark blue"),
                      labels = c("No Inundation","Inundation"),
                      name = "") +
  plotTheme()

trainProbs$predClass  = ifelse(trainProbs$pred > .32, 1, 0)

caret::confusionMatrix(reference = as.factor(trainProbs$obs), 
                       data = as.factor(trainProbs$predClass), 
                       positive = "1")
```

```{r roc_curve, message = FALSE, warning = FALSE}
ggplot(trainProbs, aes(d = obs, m = pred)) + 
  geom_roc(n.cuts = 50, labels = FALSE) + 
  style_roc(theme = theme_grey) +
  geom_abline(slope = 1, intercept = 0, size = 1.5, color = 'grey') +
  plotTheme()

auc(trainProbs$obs, trainProbs$pred)
```


```{r fig.width=10,fig.height=10}
train_cm_map_df <- cbind(Train, trainProbs) %>%
  mutate(error = case_when(predClass == obs ~ 0,
                           predClass != obs ~ 1),
         confusionMtx = case_when(predClass == 1 & obs == 1 ~ "True Positive",
                                  predClass == 1 & obs == 0 ~ "False Positive",
                                  predClass == 0 & obs == 0 ~ "True Negative",
                                  predClass == 0 & obs == 1 ~ "False Negative"))

train_cm_map_df %>%
  ggplot() +
    geom_sf(aes(fill = confusionMtx)) +
    scale_fill_viridis(direction = -1, discrete = TRUE) +
    labs(title = "Model training accuracy") +
    mapTheme()

```

## Model Cross-validation

```{r}
cal_inundationProbs <- predict(floodModel, test, type="response")

# hist(cal_inundationProbs)

testProbs <- data.frame(obs = as.numeric(test$inundation),
                        pred = cal_inundationProbs)

# ggplot(testProbs, aes(x = pred, fill=as.factor(obs))) + 
#   geom_density() +
#   facet_grid(obs ~ .) + 
#   xlab("Probability") + 
#   geom_vline(xintercept = .28) +
#   scale_fill_manual(values = c("dark green", "dark blue"),
#                       labels = c("No Inundation","Inundation"),
#                       name = "") +
#   plotTheme()
```


```{r test_confusion_matrix, message = FALSE, warning = FALSE}
testProbs$predClass  = ifelse(testProbs$pred > .28, 1, 0)

caret::confusionMatrix(reference = as.factor(testProbs$obs), 
                       data = as.factor(testProbs$predClass), 
                       positive = "1")

```

```{r test_roc_curve, message = FALSE, warning = FALSE}
ggplot(testProbs, aes(d = obs, m = pred)) + 
  geom_roc(n.cuts = 50, labels = FALSE) + 
  style_roc(theme = theme_grey) +
  geom_abline(slope = 1, intercept = 0, size = 1.5, color = 'grey') +
  plotTheme()

auc(testProbs$obs, testProbs$pred)
```

```{r fig.width=10,fig.height=10}
test_cm_map_df <- cbind(test, testProbs) %>%
  mutate(error = case_when(predClass == obs ~ 0,
                           predClass != obs ~ 1),
         confusionMtx = case_when(predClass == 1 & obs == 1 ~ "True Positive",
                                  predClass == 1 & obs == 0 ~ "False Positive",
                                  predClass == 0 & obs == 0 ~ "True Negative",
                                  predClass == 0 & obs == 1 ~ "False Negative"))

cal_FullPredictions <- rbind(train_cm_map_df, test_cm_map_df)

cal_FullPredictions %>%
  ggplot() +
    geom_sf(aes(fill = confusionMtx)) +
    scale_fill_viridis(direction = -1, discrete = TRUE) +
    labs(title = "Model training accuracy") +
    mapTheme()


cal_FullPredictions %>%
  mutate(predClass = as.factor(predClass)) %>%
  ggplot() +
    geom_sf(aes(fill = predClass)) +
    scale_fill_manual(values = c("dark green", "dark blue"),
                      labels = c("No Inundation","Inundation"),
                      name = "Predicted Inundation") +
    labs(title = "Predicted Flood Inundation Regions in Calgary, Alberta, CA") +
    mapTheme()
```
### Spatial Cross-validation

```{r eval=FALSE, include=FALSE}

coords.test <-  st_coordinates(st_centroid(train_cm_map_df)) 

neighborList.test <- nb2listw(knn2nb(knearneigh(coords.test, 5)))

# spatialWeights.test <- nb2listw(neighborList.test, style="W")

moran.test(residuals.glm(floodModel), neighborList.test)
 
# test_cm_map_df %>% 
#   mutate(lagPriceError = lag.listw(spatialWeights.test, error)) %>%
#   ggplot(aes(lagPriceError, error))
```


# Testing on a comparable city

### Pittsburgh data
```{r}
pghBoundary <- st_read('D:/Users/Johnathan/Google Drive/Grad School/Penn_MUSA/Spring2022/675_LUaEModeling/Homework/3_ForecastingFloodInundation/PittsburghData/producedData/PGHCityBoundary_expanded.shp')
```

```{r}
pgh_PredictionFishnet <- st_read('D:/Users/Johnathan/Google Drive/Grad School/Penn_MUSA/Spring2022/675_LUaEModeling/Homework/3_ForecastingFloodInundation/PittsData/pgh_toPredict')

# Clean up colnames:
pgh_PredictionFishnet <- pgh_PredictionFishnet %>%
  rename(uniqueID = pgh_fishne,
         CellAvgDistStream = pgh_avgD_5,
         CellAvgDistSteepSlope =pgh_avg_11,
         CellSumImpSurf = pgh_sumI_5,
         CellAvgDistWetland = pgh_avg_17)

pgh_PredictionFishnet <- pgh_PredictionFishnet %>%
  dplyr::select(uniqueID, CellAvgDistStream, CellAvgDistSteepSlope, CellAvgDistWetland, CellSumImpSurf)
```

```{r fig.width=12, fig.height=12}
  grid.arrange( 
    # Average Distance to stream or river features as created from a DEM
    pgh_PredictionFishnet %>%
      ggplot() +
        geom_sf(aes(fill = CellAvgDistStream)) +
        scale_fill_viridis(direction = -1) +
        labs(title = "Average Distance to Streams or Rivers") +
        mapTheme()
    ,
    # Average Distance to steep slopes as created from a DEM
    # A steep slope is defined as a rise of 20% or more
    pgh_PredictionFishnet %>%
      ggplot() +
        geom_sf(aes(fill = CellAvgDistSteepSlope)) +
        scale_fill_viridis(direction = -1) +
        labs(title = "Average Distance to Steep Slopes (>20% rise)") +
        mapTheme()
    ,
    # Average Distance to wetlands as retrieved from open data sources:
    # Alberta / Calgary: https://geospatial.alberta.ca/titan/rest/services/environment/alberta_merged_wetland_inventory/MapServer/3
    # Allegheny County / Pittsburgh: https://www.pasda.psu.edu/download/alleghenycounty/AlleghenyCounty_NWI2000.zip
    pgh_PredictionFishnet %>%
      ggplot() +
        geom_sf(aes(fill = CellAvgDistWetland)) +
        scale_fill_viridis(direction = -1) +
        labs(title = "Average Distance to Wetlands") +
        mapTheme()
    ,
    # Summary of Impervious Surfaces
    # If a cell touches an impervious surface, it will be classified as having impervious surfaces
    # Land cover data: http://www.cec.org/north-american-environmental-atlas/land-cover-30m-2015-landsat-and-rapideye/
    pgh_PredictionFishnet %>%
      ggplot() +
        geom_sf(aes(fill = CellSumImpSurf)) +
        scale_fill_viridis(direction = -1) +
        labs(title = "Summary of Impervious Surfaces") +
        mapTheme()
  , nrow=2, ncol=2
  )

```


```{r}
pgh_PredictionFishnet$inundationProbs <- predict(floodModel, pgh_PredictionFishnet, type="response")

# hist(pgh_PredictionFishnet$inundationProbs)

pgh_PredictionFishnet <- pgh_PredictionFishnet %>%
  mutate(predClass = ifelse(inundationProbs > .28 ,1,0))

```

```{r}
pgh_PredictionFishnet %>%
  mutate(predClass = as.factor(predClass)) %>%
  ggplot() +
    geom_sf(aes(fill = predClass)) +
    scale_fill_manual(values = c("dark green", "dark blue"),
                      labels = c("No Inundation","Inundation"),
                      name = "Predicted Inundation") +
    labs(title = "Predicted Flood Inundation Regions in Pittsburgh, PA, USA") +
    mapTheme()
```



#### Citations
1.Federal Emergency Management Agency. Flood Impact Fact Sheet. https://community.fema.gov/ProtectiveActions/s/article/Flood-Impact.   
2. United States, Department of Commerce, National Oceanic and Atmospheric Administration, National Severe Storms Laboratory, “Severe Weather 101: Frequently Asked Questions About Floods,” accessed December 11, 2014, https://www.nssl.noaa.gov/education/svrwx101/floods/faq/. 