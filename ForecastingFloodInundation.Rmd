---
title: "Forecasting Flood Inundation"
author: "Johnathan Clementi & Itay Porat"
date: "3/16/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Introduction & Motivation
On average, flooding results in approximately 120 fatalities and about $5 billion in property damages across the United States on an annual basis [1][2]. It is advantageous, then, to be able to predict future flooding such that it may be mitigated. This is especially common in cities, which contain large areas of impermeable surfaces and concentrate human growth. Mitigation measures include:
1. Replace impermeable surfaces
1. Install water attenuation and infiltration devices
1. Improve storm water and waste water management systems
1. **Improve warning mechanisms**
We will focus on the last of these items: **improving warning mechanisms**. To do this, we have built a machine learning model which uses terrain, distance to existing water, and to predict prior flooding in Calgary, CA. We evaluated the effectiveness of the model by testing it on data held out from the model building process. Finally, we used the model to predict flooding in Pittsburgh, PA, USA.


```{r libraries, message=FALSE, warning=FALSE}
library(caret)
library(pscl)
library(plotROC)
library(pROC)
library(sf)
library(tidyverse)
library(knitr)
library(kableExtra)
library(gridExtra)
library(tigris)
library(viridis)
library(raster)
```

```{r mapTheme, echo=TRUE}
mapTheme <- function() { 
            theme(plot.title =element_text(size=12),
                  plot.subtitle = element_text(size=8),
                  plot.caption = element_text(size = 6),
                  axis.line=element_blank(),
                  axis.text.x=element_blank(),
                  axis.text.y=element_blank(),
                  axis.ticks=element_blank(),
                  axis.title.x=element_blank(),
                  axis.title.y=element_blank(),
                  panel.background=element_blank(),
                  panel.border=element_blank(),
                  panel.grid.major=element_line(colour = 'transparent'),
                  panel.grid.minor=element_blank(),
                  legend.direction = "vertical", 
                  legend.position = "right",
                  plot.margin = margin(1, 1, 1, 1, 'cm'),
                  legend.key.height = unit(1, "cm"), legend.key.width = unit(0.2, "cm"))
            }

plotTheme() <- function() { 
              theme(plot.title =element_text(size=12),
                    plot.subtitle = element_text(size=8),
                    plot.caption = element_text(size = 6),
                    axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
                    axis.text.y = element_text(size = 10),
                    axis.title.y = element_text(size = 10),
                    # Set the entire chart region to blank
                    panel.background=element_blank(),
                    plot.background=element_blank(),
                    #panel.border=element_rect(colour="#F0F0F0"),
                    # Format the grid
                    panel.grid.major=element_line(colour="#D0D0D0",size=.75),
                    axis.ticks=element_blank())
              }
```

## Model Components: Data

### Calgary Data
```{r}
calgaryBoundary <- st_read('https://data.calgary.ca/resource/erra-cqp9.geojson') %>%
  st_transform(crs = 3776)
```


### Pittsburgh data
```{r}
pghBoundary <- st_read('D:/Users/Johnathan/Google Drive/Grad School/Penn_MUSA/Spring2022/675_LUaEModeling/Homework/3_ForecastingFloodInundation/PittsburghData/producedData/PGHCityBoundary_expanded.shp')
```

```{r createFishnet}
### Create Fishnet
# cal_fishnet <- st_make_grid(calgaryBoundary, cellsize = 500, square = TRUE) %>%
#   .[calgaryBoundary] %>% # Clips to original boundary
#   st_sf() %>%
#   mutate(uniqueID = rownames(.))


# pgh_fishnet <- st_make_grid(pghBoundary, cellsize = 500, square = TRUE) %>%
#   .[pghBoundary] %>% # Clips to original boundary 
#   st_sf() %>%
#   mutate(uniqueID = rownames(.))

# st_write(cal_fishnet, 'D:/Users/Johnathan/Google Drive/Grad School/Penn_MUSA/Spring2022/675_LUaEModeling/Homework/3_ForecastingFloodInundation/CalgaryData/fishnet/cal_fishnet.shp')

# st_write(pgh_fishnet, 'D:/Users/Johnathan/Google Drive/Grad School/Penn_MUSA/Spring2022/675_LUaEModeling/Homework/3_ForecastingFloodInundation/PittsburghData/producedData/pgh_fishnet.shp')

cal_fishnet <- st_read('D:/Users/Johnathan/Google Drive/Grad School/Penn_MUSA/Spring2022/675_LUaEModeling/Homework/3_ForecastingFloodInundation/CalgaryData/fishnet/cal_fishnet.shp')

pgh_fishnet <- st_read('D:/Users/Johnathan/Google Drive/Grad School/Penn_MUSA/Spring2022/675_LUaEModeling/Homework/3_ForecastingFloodInundation/PittsburghData/producedData/pgh_fishnet.shp')
```

```{r fig.height=12, fig.width=24}
calFish <- ggplot() +
  geom_sf(data = cal_fishnet) +
  geom_sf(data = calgaryBoundary, 
          color = "red", fill = "transparent") +
  mapTheme()

pghFish <- ggplot() +
  geom_sf(data = pgh_fishnet) +
  geom_sf(data = pghBoundary, 
          color = "red", fill = "transparent") +
  mapTheme()

grid.arrange(calFish, pghFish, nrow = 1)
```

```{r}
cal_PredictionFishnet <- st_read('D:/Users/Johnathan/Google Drive/Grad School/Penn_MUSA/Spring2022/675_LUaEModeling/Homework/3_ForecastingFloodInundation/CalgaryData/cal_toPredict.shp')

# Clean up colnames:
cal_PredictionFishnet <- cal_PredictionFishnet %>%
  rename(uniqueID = cal_fishne,
         CellAvgDistStream = calFish_17,
         CellAvgDistSteepSlope = calFish_11,
         CellAvgDistWetland = calFish__5,
         CellSumImpSurf = calFish_22,
         inundation = calFish_27)

# Make uniqueID numeric
cal_PredictionFishnet$uniqueID <- as.numeric(cal_PredictionFishnet$uniqueID)
```

#### Dependent Variable Visualization
```{r}

```


#### Indpendent Variable Visualizations
```{r}

```


### Wrangle Prediction Set
```{r}
predData <- cal_PredictionFishnet %>%
  dplyr::select(inundation, CellAvgDistStream, CellAvgDistSteepSlope, CellAvgDistWetland, CellSumImpSurf) %>%
  st_drop_geometry()
```


## Model Components: Build Model

```{r}
set.seed(4326)
trainIdx <- createDataPartition(predData$CellAvgDistSteepSlope, p=.7,
                                list=FALSE,
                                times=1)
Train <- predData[trainIdx,]
test <- predData[-trainIdx,]
```

```{r}
floodModel <- glm(inundation ~ ., family="binomial"(link="logit"),
                  data = Train %>% as.data.frame())

summary(floodModel)
```

```{r}
cal_inundationProbs <- predict(floodModel, test, type="response")

hist(cal_inundationProbs)
```

```{r plot_preds}
testProbs <- data.frame(obs = as.numeric(test$inundation),
                        pred = cal_inundationProbs)

ggplot(testProbs, aes(x = pred, fill=as.factor(obs))) + 
  geom_density() +
  facet_grid(obs ~ .) + 
  xlab("Probability") + 
  geom_vline(xintercept = .32) +
  scale_fill_manual(values = c("dark green", "dark blue"),
                      labels = c("No Inundation","Inundation"),
                      name = "") +
  plotTheme()
```

```{r confusion_matrix, message = FALSE, warning = FALSE}
testProbs$predClass  = ifelse(testProbs$pred > .32 ,1,0)

caret::confusionMatrix(reference = as.factor(testProbs$obs), 
                       data = as.factor(testProbs$predClass), 
                       positive = "1")

```

```{r roc_curve, message = FALSE, warning = FALSE}

ggplot(testProbs, aes(d = obs, m = pred)) + 
  geom_roc(n.cuts = 50, labels = FALSE) + 
  style_roc(theme = theme_grey) +
  geom_abline(slope = 1, intercept = 0, size = 1.5, color = 'grey') +
  plotTheme()

auc(testProbs$obs, testProbs$pred)
```

# Testing on a comparable city
```{r}
pgh_PredictionFishnet <- st_read('D:/Users/Johnathan/Google Drive/Grad School/Penn_MUSA/Spring2022/675_LUaEModeling/Homework/3_ForecastingFloodInundation/PittsData/pgh_toPredict')

# Clean up colnames:
pgh_PredictionFishnet <- pgh_PredictionFishnet %>%
  rename(uniqueID = pgh_fishne,
         CellAvgDistStream = pgh_avgD_5,
         CellAvgDistSteepSlope =pgh_avg_11,
         CellSumImpSurf = pgh_sumI_5,
         CellAvgDistWetland = pgh_avg_17)

pgh_PredictionFishnet <- pgh_PredictionFishnet %>%
  dplyr::select(CellAvgDistStream, CellAvgDistSteepSlope, CellAvgDistWetland, CellSumImpSurf)
```

```{r}
pgh_inundationProbs <- predict(floodModel, test, type="response")

hist(pgh_inundationProbs)

pgh_inundationProbs <- data.frame(pgh_inundationProbs)
pgh_inundationProbs$predClass  = ifelse(pgh_inundationProbs$pgh_inundationProbs > .32 ,1,0)
```

#### Citations
1.Federal Emergency Management Agency. Flood Impact Fact Sheet. https://community.fema.gov/ProtectiveActions/s/article/Flood-Impact.   
2. United States, Department of Commerce, National Oceanic and Atmospheric Administration, National Severe Storms Laboratory, “Severe Weather 101: Frequently Asked Questions About Floods,” accessed December 11, 2014, https://www.nssl.noaa.gov/education/svrwx101/floods/faq/. 